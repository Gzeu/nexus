name: Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true # Don't fail the build on security warnings initially
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked
        continue-on-error: true

      - name: Run cargo audit
        run: cargo audit
        continue-on-error: true

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked
        continue-on-error: true

      - name: Run cargo deny (advisories only)
        run: cargo deny check advisories
        continue-on-error: true

  static-analysis:
    name: Static Analysis Security Testing (SAST)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-sast-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run security-focused clippy lints
        run: |
          cargo clippy --all-targets --all-features -- \
            -A clippy::missing_errors_doc \
            -A clippy::missing_panics_doc \
            -A clippy::module_name_repetitions \
            -W clippy::suspicious
        continue-on-error: true

      - name: Check for unsafe code
        run: |
          if find crates/ -name "*.rs" -exec grep -l "unsafe" {} \; | head -10; then
            echo "Unsafe code found (review recommended but not blocking)"
          else
            echo "No unsafe code detected."
          fi

      - name: Basic secrets scan
        run: |
          echo "Scanning for potential hardcoded secrets..."
          
          # Very basic scan to avoid false positives
          if grep -r "password.*=.*\"[a-zA-Z0-9]{12,}\"" crates/ --include="*.rs" | grep -v test | head -5; then
            echo "Potential hardcoded secrets found (review recommended)"
          else
            echo "No obvious hardcoded secrets detected."
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: high
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Unicode-DFS-2016, CC0-1.0
        continue-on-error: true

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Simple license check
        run: |
          echo "# License Check Report" > license-report.md
          echo "Generated on: $(date)" >> license-report.md
          echo "" >> license-report.md
          
          # Basic license validation - check Cargo.toml files
          find . -name "Cargo.toml" -exec grep -H "license" {} \; >> license-report.md
          
          echo "License check completed"

      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-compliance-report
          path: license-report.md
          retention-days: 30
        continue-on-error: true