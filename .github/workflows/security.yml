name: Security Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-security-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Install cargo-outdated
        run: cargo install cargo-outdated --locked

      - name: Run cargo audit
        run: cargo audit --json > audit-results.json
        continue-on-error: true

      - name: Run cargo deny
        run: |
          cargo deny check advisories --format json > deny-advisories.json
          cargo deny check licenses --format json > deny-licenses.json
          cargo deny check bans --format json > deny-bans.json
        continue-on-error: true

      - name: Check for outdated dependencies
        run: cargo outdated --format json > outdated.json
        continue-on-error: true

      - name: Upload security scan results
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: |
            audit-results.json
            deny-*.json
            outdated.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        run: |
          if grep -q '"type": "vulnerability"' audit-results.json; then
            echo "Critical vulnerabilities found!"
            cat audit-results.json
            exit 1
          fi

  static-analysis:
    name: Static Analysis Security Testing (SAST)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-sast-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run security-focused clippy lints
        run: |
          cargo clippy --all-targets --all-features -- \
            -D clippy::integer_overflow \
            -D clippy::panic \
            -D clippy::unwrap_used \
            -D clippy::expect_used \
            -D clippy::mem_forget \
            -D clippy::suspicious \
            -D clippy::nursery

      - name: Check for unsafe code
        run: |
          if grep -r "unsafe" crates/ --include="*.rs"; then
            echo "Unsafe code found! Please review:"
            grep -r "unsafe" crates/ --include="*.rs" -n
            # Don't fail the build, but flag for review
          else
            echo "No unsafe code detected."
          fi

      - name: Scan for hardcoded secrets
        run: |
          # Basic regex patterns for common secrets
          echo "Scanning for potential hardcoded secrets..."
          
          # API keys and tokens
          if grep -r -i "api[_-]key\|secret[_-]key\|access[_-]token" crates/ --include="*.rs" | grep -v "// TODO\|// FIXME\|placeholder"; then
            echo "Potential hardcoded API keys found!"
            exit 1
          fi
          
          # Private keys
          if grep -r "BEGIN.*PRIVATE KEY" crates/ --include="*.rs"; then
            echo "Potential hardcoded private keys found!"
            exit 1
          fi
          
          # Passwords
          if grep -r -i "password.*=.*\"[^\"]{8,}\"" crates/ --include="*.rs" | grep -v "test\|example"; then
            echo "Potential hardcoded passwords found!"
            exit 1
          fi
          
          echo "No obvious hardcoded secrets detected."

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Unicode-DFS-2016, CC0-1.0

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    
    strategy:
      fail-fast: false
      matrix:
        language: [ 'rust' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build project
        run: cargo build --all --release

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/language:${{matrix.language}}"

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-license
        run: cargo install cargo-license --locked

      - name: Generate license report
        run: |
          echo "# License Compliance Report" > license-report.md
          echo "Generated on: $(date)" >> license-report.md
          echo "" >> license-report.md
          cargo license --json | jq -r '.[] | "- \(.name) (\(.version)): \(.license // "Unknown")"' >> license-report.md

      - name: Check for forbidden licenses
        run: |
          FORBIDDEN_LICENSES="GPL-2.0 GPL-3.0 AGPL-1.0 AGPL-3.0 EUPL-1.1 EUPL-1.2 LGPL-2.0 LGPL-2.1 LGPL-3.0"
          
          for license in $FORBIDDEN_LICENSES; do
            if cargo license --json | jq -e ".[] | select(.license == \"$license\")" > /dev/null; then
              echo "Forbidden license found: $license"
              cargo license --json | jq ".[] | select(.license == \"$license\")"
              exit 1
            fi
          done
          
          echo "No forbidden licenses detected."

      - name: Upload license report
        uses: actions/upload-artifact@v3
        with:
          name: license-compliance-report
          path: license-report.md
          retention-days: 30

  security-scorecard:
    name: OSSF Scorecard
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          
      - name: Run analysis
        uses: ossf/scorecard-action@v2.3.1
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true
          
      - name: Upload SARIF results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
